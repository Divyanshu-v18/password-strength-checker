// DOM Elements
const passwordInput = document.getElementById('passwordInput');
const toggleBtn = document.getElementById('toggleBtn');
const copyBtn = document.getElementById('copyBtn');
const strengthBar = document.getElementById('strengthBar');
const strengthLabel = document.getElementById('strengthLabel');
const crackTime = document.getElementById('crackTime');

// Requirement elements
const reqLength = document.getElementById('req-length');
const reqUppercase = document.getElementById('req-uppercase');
const reqLowercase = document.getElementById('req-lowercase');
const reqNumber = document.getElementById('req-number');
const reqSpecial = document.getElementById('req-special');
const reqCommon = document.getElementById('req-common');

// Common passwords list
let commonPasswords = new Set();

// Load common passwords
fetch('common_passwords.txt')
    .then(response => response.text())
    .then(data => {
        commonPasswords = new Set(data.split('\n').map(p => p.trim().toLowerCase()));
    })
    .catch(err => console.log('Common passwords file not found, skipping dictionary check'));

// Toggle password visibility
toggleBtn.addEventListener('click', () => {
    const type = passwordInput.type === 'password' ? 'text' : 'password';
    passwordInput.type = type;
    
    const eyeIcon = document.getElementById('eyeIcon');
    if (type === 'text') {
        eyeIcon.innerHTML = `
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
    } else {
        eyeIcon.innerHTML = `
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        `;
    }
});

// Copy password to clipboard
copyBtn.addEventListener('click', async () => {
    const password = passwordInput.value;
    
    if (!password) {
        copyBtn.classList.add('shake');
        setTimeout(() => copyBtn.classList.remove('shake'), 300);
        return;
    }
    
    try {
        await navigator.clipboard.writeText(password);
        
        // Visual feedback
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        `;
        copyBtn.style.color = '#48bb78';
        
        setTimeout(() => {
            copyBtn.innerHTML = originalHTML;
            copyBtn.style.color = '';
        }, 2000);
    } catch (err) {
        console.error('Failed to copy:', err);
    }
});

// Password strength checker
passwordInput.addEventListener('input', () => {
    const password = passwordInput.value;
    
    if (!password) {
        resetStrength();
        return;
    }
    
    checkPasswordStrength(password);
});

function checkPasswordStrength(password) {
    let score = 0;
    const checks = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[^A-Za-z0-9]/.test(password),
        common: !commonPasswords.has(password.toLowerCase())
    };
    
    // Update requirement indicators
    updateRequirement(reqLength, checks.length);
    updateRequirement(reqUppercase, checks.uppercase);
    updateRequirement(reqLowercase, checks.lowercase);
    updateRequirement(reqNumber, checks.number);
    updateRequirement(reqSpecial, checks.special);
    updateRequirement(reqCommon, checks.common);
    
    // If password is too short, cap at weak
    if (password.length < 8) {
        strengthBar.className = 'strength-bar weak';
        strengthLabel.className = 'strength-label weak';
        strengthLabel.textContent = 'Too Short';
        crackTime.textContent = 'Instantly crackable';
        return;
    }
    
    // Calculate score (only if length requirement is met)
    if (checks.length) score += 20;
    if (checks.uppercase) score += 15;
    if (checks.lowercase) score += 15;
    if (checks.number) score += 15;
    if (checks.special) score += 20;
    if (checks.common) score += 15;
    
    // Bonus for length
    if (password.length >= 12) score += 10;
    if (password.length >= 16) score += 10;
    
    // Penalty for not being common
    if (!checks.common) score -= 20;
    
    // Determine strength level
    let strength, label, time;
    
    if (score < 50) {
        strength = 'weak';
        label = 'Weak';
        time = 'Minutes to crack';
    } else if (score < 70) {
        strength = 'fair';
        label = 'Fair';
        time = 'Hours to crack';
    } else if (score < 85) {
        strength = 'good';
        label = 'Good';
        time = 'Months to crack';
    } else {
        strength = 'strong';
        label = 'Strong';
        time = 'Years to crack';
    }
    
    // Update UI
    strengthBar.className = `strength-bar ${strength}`;
    strengthLabel.className = `strength-label ${strength}`;
    strengthLabel.textContent = label;
    crackTime.textContent = time;
}

function updateRequirement(element, isMet) {
    if (isMet) {
        element.classList.remove('unmet');
        element.classList.add('met');
    } else {
        element.classList.remove('met');
        element.classList.add('unmet');
    }
}

function resetStrength() {
    strengthBar.className = 'strength-bar';
    strengthBar.style.width = '0%';
    strengthLabel.className = 'strength-label';
    strengthLabel.textContent = 'Enter a password';
    crackTime.textContent = '';
    
    // Reset all requirements
    [reqLength, reqUppercase, reqLowercase, reqNumber, reqSpecial, reqCommon].forEach(req => {
        req.classList.remove('met', 'unmet');
    });
}
